<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zona Total Noticias - Información al instante</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <style>
        /* Estilos adicionales para noticias */
        .news-priority {
            position: absolute;
            top: 15px;
            right: 15px;
            background-color: var(--accent-orange);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            z-index: 2;
        }

        .no-news-admin {
            text-align: center;
            padding: 30px;
            background-color: var(--medium-gray);
            border-radius: 8px;
            color: var(--text-secondary);
        }

        .processing, .success, .error {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .processing {
            background-color: rgba(255, 193, 7, 0.1);
            color: #ffc107;
            border-left: 4px solid #ffc107;
        }

        .success {
            background-color: rgba(76, 175, 80, 0.1);
            color: #4caf50;
            border-left: 4px solid #4caf50;
        }

        .error {
            background-color: rgba(244, 67, 54, 0.1);
            color: #f44336;
            border-left: 4px solid #f44336;
        }

        .news-country {
            display: flex;
            align-items: center;
            gap: 5px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .modal-summary {
            background-color: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid var(--accent-orange);
        }

        .modal-summary h4 {
            color: var(--accent-orange);
            margin-bottom: 10px;
        }

        /* Formulario de agregar noticia */
        #add-news-form {
            margin-top: 20px;
        }

        #add-news-form .form-group {
            margin-bottom: 15px;
        }

        #add-news-form label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-color);
            font-weight: 500;
        }

        #add-news-form input,
        #add-news-form select,
        #add-news-form textarea {
            width: 100%;
            padding: 10px;
            background-color: var(--medium-gray);
            border: 1px solid var(--secondary-blue);
            border-radius: 4px;
            color: var(--text-color);
            font-family: 'Montserrat', sans-serif;
        }

        #add-news-form textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        pre {
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header & Navigation -->
    <header class="header">
        <div class="container">
            <nav class="navbar">
                <div class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-newspaper"></i>
                    </div>
                    <span class="logo-text">Zona Total</span>
                </div>
                
                <ul class="nav-menu">
                    <li><a href="#home" class="nav-link active">Inicio</a></li>
                    <li><a href="#news" class="nav-link">Noticias</a></li>
                    <li><a href="#categories" class="nav-link">Categorías</a></li>
                    <li><a href="#contact" class="nav-link">Contacto</a></li>
                    <li><a href="#" id="admin-access-btn" class="nav-link admin-access">
                        <i class="fas fa-lock"></i> Admin
                    </a></li>
                </ul>
                
                <div class="hamburger">
                    <span class="bar"></span>
                    <span class="bar"></span>
                    <span class="bar"></span>
                </div>
            </nav>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="hero" id="home">
        <div class="container">
            <div class="hero-content">
                <h1 class="hero-title">Zona Total <span class="highlight">Noticias</span></h1>
                <p class="hero-subtitle">Información al instante, noticias verificadas y cobertura completa de los eventos más importantes.</p>
                
                <div class="hero-buttons">
                    <a href="#news" class="btn btn-primary">Ver Noticias</a>
                    <a href="#categories" class="btn btn-secondary">Explorar Categorías</a>
                </div>
            </div>
            
            <div class="hero-stats">
                <div class="stat">
                    <div class="stat-number" id="total-news">0</div>
                    <div class="stat-text">Noticias Publicadas</div>
                </div>
                <div class="stat">
                    <div class="stat-number">24/7</div>
                    <div class="stat-text">Actualización</div>
                </div>
                <div class="stat">
                    <div class="stat-number">100%</div>
                    <div class="stat-text">Verificado</div>
                </div>
            </div>
        </div>
    </section>

    <!-- News Section -->
    <section class="news-section" id="news">
        <div class="container">
            <div class="section-header">
                <h2 class="section-title">Últimas Noticias</h2>
                <p class="section-subtitle">Mantente informado con nuestras noticias más recientes</p>
            </div>
            
            <!-- Filters -->
            <div class="filters">
                <div class="filter-buttons" id="filter-buttons">
                    <button class="filter-btn active" data-category="todas">Todas</button>
                    <!-- Categories will be loaded from Google Sheets -->
                </div>
                
                <div class="search-box">
                    <input type="text" id="search-input" placeholder="Buscar noticias...">
                    <i class="fas fa-search"></i>
                </div>
            </div>
            
            <!-- Loading State -->
            <div id="loading-news" class="loading-state">
                <div class="loading-spinner">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
                <p>Cargando noticias...</p>
            </div>
            
            <!-- Error State -->
            <div id="error-news" class="error-state" style="display: none;">
                <div class="error-content">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>Error al cargar las noticias</h3>
                    <p id="error-message"></p>
                    <button class="btn btn-primary" id="retry-load-btn">Reintentar</button>
                </div>
            </div>
            
            <!-- News Grid -->
            <div class="news-grid" id="news-grid">
                <!-- News will be loaded dynamically from Google Sheets -->
            </div>
            
            <!-- Load More Button -->
            <div class="load-more-container">
                <button class="btn btn-secondary" id="load-more-btn">
                    <i class="fas fa-plus"></i> Cargar más noticias
                </button>
            </div>
        </div>
    </section>

    <!-- Categories Section -->
    <section class="categories-section" id="categories">
        <div class="container">
            <div class="section-header">
                <h2 class="section-title">Categorías</h2>
                <p class="section-subtitle">Explora noticias por temas de interés</p>
            </div>
            
            <div class="categories-grid" id="categories-grid">
                <!-- Categories will be loaded from Google Sheets -->
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer" id="contact">
        <div class="container">
            <div class="footer-content">
                <div class="footer-logo">
                    <h3>Zona Total Noticias</h3>
                    <p>Tu fuente confiable de información. Noticias verificadas y actualizadas minuto a minuto.</p>
                </div>
                
                <div class="footer-info">
                    <p><i class="fas fa-envelope"></i> contacto@zonatotal.com</p>
                    <p><i class="fas fa-phone"></i> +1 (555) 987-6543</p>
                    <p><i class="fas fa-map-marker-alt"></i> Av. Noticias 456, Ciudad Actualidad</p>
                    <p><i class="fas fa-clock"></i> Actualización 24/7</p>
                </div>
            </div>
            
            <div class="footer-bottom">
                <p>&copy; 2024 Zona Total Noticias. Todos los derechos reservados.</p>
                <p class="footer-note">Información verificada para lectores exigentes</p>
            </div>
        </div>
    </footer>

    <!-- News Modal -->
    <div class="modal-overlay" id="news-modal">
        <div class="modal-container">
            <div class="modal-header">
                <h3 id="modal-news-title">Detalles de la Noticia</h3>
                <button class="modal-close" id="modal-close">&times;</button>
            </div>
            <div class="modal-content">
                <div id="modal-news-content">
                    <!-- News details will be loaded here -->
                </div>
                <div class="modal-actions">
                    <button class="btn btn-primary" id="share-btn">
                        <i class="fas fa-share"></i> Compartir
                    </button>
                    <button class="btn btn-secondary" id="close-modal-btn">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div class="admin-overlay" id="admin-overlay">
        <div class="admin-container">
            <!-- Admin Login -->
            <div class="admin-login" id="admin-login">
                <div class="login-header">
                    <h3><i class="fas fa-lock"></i> Panel de Administración</h3>
                    <p>Gestiona las noticias desde tu Google Sheets</p>
                </div>
                
                <div class="login-form" id="login-form">
                    <div class="form-group">
                        <label for="admin-username">Usuario</label>
                        <input type="text" id="admin-username" value="admin" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="admin-password">Contraseña</label>
                        <input type="password" id="admin-password" value="admin123" readonly>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-primary" id="login-btn">Ingresar</button>
                        <button type="button" class="btn btn-secondary" id="cancel-login-btn">Cancelar</button>
                    </div>
                </div>
                
                <div class="login-info">
                    <p><strong>Instrucciones:</strong></p>
                    <p>1. Usa tu Google Sheets para agregar noticias</p>
                    <p>2. Actualiza la página para ver los cambios</p>
                    <p>3. Las credenciales son de solo lectura</p>
                </div>
                
                <div class="sheet-link">
                    <a href="https://docs.google.com/spreadsheets/d/1YAqfZadMR5O6mABhl0QbhF8scbtIW9JJPfwdED4bzDQ/edit#gid=1201067322" 
                       target="_blank" class="btn btn-small">
                        <i class="fas fa-external-link-alt"></i> Abrir Google Sheets
                    </a>
                </div>
            </div>
            
            <!-- Admin Panel -->
            <div class="admin-panel" id="admin-panel" style="display: none;">
                <div class="admin-header">
                    <h3><i class="fas fa-cogs"></i> Panel de Control</h3>
                    <button class="btn btn-small" id="logout-btn">Cerrar Sesión</button>
                </div>
                
                <div class="admin-tabs">
                    <button class="tab-btn active" data-tab="news-tab">Noticias</button>
                    <button class="tab-btn" data-tab="add-news-tab">Agregar Noticia</button>
                    <button class="tab-btn" data-tab="stats-tab">Estadísticas</button>
                </div>
                
                <!-- News Management Tab -->
                <div class="tab-content active" id="news-tab">
                    <h4>Gestión de Noticias</h4>
                    <div class="admin-info">
                        <p>Las noticias se gestionan directamente desde Google Sheets. Actualiza la página web después de realizar cambios.</p>
                        <div class="admin-actions">
                            <a href="https://docs.google.com/spreadsheets/d/1YAqfZadMR5O6mABhl0QbhF8scbtIW9JJPfwdED4bzDQ/edit#gid=1201067322" 
                               target="_blank" class="btn btn-primary">
                                <i class="fas fa-edit"></i> Editar Google Sheets
                            </a>
                            <button class="btn btn-secondary" id="refresh-news-btn">
                                <i class="fas fa-sync-alt"></i> Actualizar Noticias
                            </button>
                        </div>
                    </div>
                    
                    <div class="news-list-header">
                        <h5>Noticias Recientes</h5>
                        <span id="news-count">Cargando...</span>
                    </div>
                    
                    <div class="admin-news-list" id="admin-news-list">
                        <!-- News will be loaded from Google Sheets -->
                    </div>
                </div>
                
                <!-- Add News Tab -->
                <div class="tab-content" id="add-news-tab">
                    <h4>Agregar Nueva Noticia</h4>
                    <form id="add-news-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="news-title">Título *</label>
                                <input type="text" id="news-title" required>
                            </div>
                            <div class="form-group">
                                <label for="news-category">Categoría *</label>
                                <select id="news-category" required>
                                    <option value="">Seleccionar categoría</option>
                                    <option value="Política">Política</option>
                                    <option value="Deportes">Deportes</option>
                                    <option value="Economía">Economía</option>
                                    <option value="Tecnología">Tecnología</option>
                                    <option value="Entretenimiento">Entretenimiento</option>
                                    <option value="Salud">Salud</option>
                                    <option value="General">General</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="news-country">País</label>
                                <input type="text" id="news-country" placeholder="Ej: España">
                            </div>
                            <div class="form-group">
                                <label for="news-date">Fecha</label>
                                <input type="text" id="news-date" placeholder="DD/MM/AAAA">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="news-description">Descripción *</label>
                            <textarea id="news-description" rows="3" required></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="news-content">Contenido Completo *</label>
                            <textarea id="news-content" rows="5" required></textarea>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="news-priority">Prioridad (1-5)</label>
                                <select id="news-priority">
                                    <option value="1">1 - Normal</option>
                                    <option value="2">2</option>
                                    <option value="3">3 - Importante</option>
                                    <option value="4">4</option>
                                    <option value="5">5 - Muy Importante</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="news-image">URL de Imagen</label>
                                <input type="text" id="news-image" placeholder="https://ejemplo.com/imagen.jpg">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="news-source">Fuente</label>
                            <input type="text" id="news-source" placeholder="Zona Total" value="Zona Total">
                        </div>
                        
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Agregar Noticia
                            </button>
                            <button type="reset" class="btn btn-secondary">Limpiar</button>
                        </div>
                    </form>
                    
                    <div id="form-status" style="margin-top: 20px;"></div>
                    
                    <div class="admin-instructions" style="margin-top: 30px;">
                        <h5>Instrucciones para guardar en Google Sheets:</h5>
                        <ol>
                            <li>Agrega la noticia usando el formulario</li>
                            <li>Copia los datos que aparecerán abajo</li>
                            <li>Abre tu Google Sheets</li>
                            <li>Pega los datos en una nueva fila</li>
                            <li>Actualiza la página web para ver los cambios</li>
                        </ol>
                    </div>
                </div>
                
                <!-- Stats Tab -->
                <div class="tab-content" id="stats-tab">
                    <h4>Estadísticas del Sitio</h4>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-newspaper"></i>
                            </div>
                            <div class="stat-info">
                                <h5>Total Noticias</h5>
                                <div class="stat-number" id="admin-total-news">0</div>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-folder"></i>
                            </div>
                            <div class="stat-info">
                                <h5>Categorías</h5>
                                <div class="stat-number" id="admin-total-categories">0</div>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-calendar"></i>
                            </div>
                            <div class="stat-info">
                                <h5>Última Actualización</h5>
                                <div class="stat-number" id="last-update">--</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="admin-instructions">
                        <h5>Instrucciones para agregar noticias:</h5>
                        <ol>
                            <li>Abre tu Google Sheets usando el botón arriba</li>
                            <li>Agrega una nueva fila con los datos de la noticia</li>
                            <li>Guarda los cambios en Google Sheets</li>
                            <li>Actualiza la página web para ver los cambios</li>
                        </ol>
                        <p class="note"><strong>Nota:</strong> No uses caracteres especiales como comillas dobles (") en las celdas</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURACIÓN DE GOOGLE SHEETS (CSV público)
        const GOOGLE_SHEETS_ID = '1YAqfZadMR5O6mABhl0QbhF8scbtIW9JJPfwdED4bzDQ';
        const SHEET_GID = '1201067322'; // El gid de tu hoja
        const GOOGLE_SHEETS_CSV_URL = `https://docs.google.com/spreadsheets/d/${GOOGLE_SHEETS_ID}/export?format=csv&gid=${SHEET_GID}`;

        // Variables globales
        let news = [];
        let categories = [];
        let filteredNews = [];
        let currentCategory = 'todas';
        let searchQuery = '';
        let newsPerPage = 6;
        let currentPage = 1;

        // =============== INICIALIZACIÓN ===============
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Zona Total Noticias - Iniciando...');
            
            // Inicializar componentes
            initNavigation();
            initSearch();
            initModal();
            initAdmin();
            
            // Cargar noticias desde Google Sheets
            loadNewsFromGoogleSheets();
            
            // Configurar el botón "Cargar más"
            const loadMoreBtn = document.getElementById('load-more-btn');
            if (loadMoreBtn) {
                loadMoreBtn.addEventListener('click', loadMoreNews);
            }
        });

        // =============== CARGAR NOTICIAS DESDE GOOGLE SHEETS ===============
        async function loadNewsFromGoogleSheets() {
            showLoading(true);
            
            try {
                // Usar un proxy CORS para evitar problemas
                const proxyUrl = 'https://api.allorigins.win/raw?url=';
                const response = await fetch(proxyUrl + encodeURIComponent(GOOGLE_SHEETS_CSV_URL));
                
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
                const csvText = await response.text();
                parseNewsFromCSV(csvText);
                
                showLoading(false);
                
            } catch (error) {
                console.error('Error cargando Google Sheets:', error);
                
                // Si hay error, cargar noticias de ejemplo
                loadSampleNews();
                showError('No se pudieron cargar las noticias de Google Sheets. Mostrando noticias de ejemplo.');
                showLoading(false);
            }
        }

        function parseNewsFromCSV(csvText) {
            try {
                // Parsear CSV
                const rows = csvText.split('\n').filter(row => row.trim() !== '');
                
                if (rows.length <= 1) {
                    showError('No hay noticias en Google Sheets. Agrega noticias desde el panel Admin.');
                    loadSampleNews();
                    return;
                }
                
                // Obtener encabezados (primera fila)
                const headers = parseCSVRow(rows[0]);
                
                // Parsear cada fila de noticias
                news = [];
                categories = new Set();
                
                for (let i = 1; i < rows.length; i++) {
                    const values = parseCSVRow(rows[i]);
                    
                    if (values.length >= 3) { // Al menos título, descripción y categoría
                        const newsItem = {
                            id: i,
                            title: values[0] || `Noticia ${i}`,
                            description: values[1] || '',
                            category: values[2] || 'General',
                            country: values[3] || '',
                            date: values[4] || new Date().toLocaleDateString('es-ES'),
                            priority: parseInt(values[5]) || 1,
                            image: values[6] || getDefaultImage(values[2]),
                            content: values[7] || values[1] || 'Contenido no disponible.',
                            source: values[8] || 'Zona Total',
                            excerpt: generateExcerpt(values[1] || values[7], 150),
                            active: true
                        };
                        
                        news.push(newsItem);
                        categories.add(newsItem.category);
                    }
                }
                
                console.log(`Cargadas ${news.length} noticias de Google Sheets`);
                
                // Ordenar por prioridad y fecha
                news.sort((a, b) => {
                    if (b.priority !== a.priority) {
                        return b.priority - a.priority;
                    }
                    
                    try {
                        const dateA = new Date(a.date.split('/').reverse().join('-'));
                        const dateB = new Date(b.date.split('/').reverse().join('-'));
                        return dateB - dateA;
                    } catch {
                        return 0;
                    }
                });
                
                // Actualizar la interfaz
                updateCategories();
                filterNews();
                renderNews();
                renderCategories();
                updateNewsCount();
                updateAdminStats();
                
            } catch (error) {
                console.error('Error parseando CSV:', error);
                showError('Error procesando los datos. Verifica el formato de Google Sheets.');
                loadSampleNews();
            }
        }

        function parseCSVRow(row) {
            const values = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < row.length; i++) {
                const char = row[i];
                const nextChar = row[i + 1];
                
                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    values.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            values.push(current);
            return values.map(v => v.replace(/^"|"$/g, '').trim());
        }

        function loadSampleNews() {
            // Noticias de ejemplo
            news = [
                {
                    id: 1,
                    title: "Nueva Ley de Educación aprobada en el Congreso",
                    description: "El Congreso Nacional ha aprobado hoy la nueva Ley de Educación con una amplia mayoría.",
                    category: "Política",
                    country: "España",
                    date: "15/01/2024",
                    priority: 5,
                    image: "https://images.unsplash.com/photo-1589652717521-10c0d092dea9?w=800&q=80",
                    content: "El Congreso Nacional ha aprobado hoy la nueva Ley de Educación con una amplia mayoría. La ley incluye reformas en el sistema de evaluación y mayores recursos para escuelas públicas. Los cambios entrarán en vigor el próximo curso académico.",
                    source: "Zona Total",
                    excerpt: "Reforma educativa aprobada con apoyo multipartidista",
                    active: true
                },
                {
                    id: 2,
                    title: "Equipo local gana el campeonato nacional",
                    description: "En un emocionante partido final, nuestro equipo local se coronó campeón nacional.",
                    category: "Deportes",
                    country: "México",
                    date: "14/01/2024",
                    priority: 4,
                    image: "https://images.unsplash.com/photo-1461896836934-ffe607ba8211?w=800&q=80",
                    content: "En un emocionante partido final, nuestro equipo local se coronó campeón nacional tras vencer 3-2 en tiempo extra. Miles de fanáticos celebraron en las calles de la ciudad. El entrenador declaró que este es el mayor logro en la historia del club.",
                    source: "Zona Total",
                    excerpt: "Victoria histórica en el torneo nacional de fútbol",
                    active: true
                },
                {
                    id: 3,
                    title: "Nueva tecnología revoluciona el mercado",
                    description: "Una startup local ha desarrollado una tecnología que promete cambiar la forma en que interactuamos con dispositivos.",
                    category: "Tecnología",
                    country: "Estados Unidos",
                    date: "13/01/2024",
                    priority: 3,
                    image: "https://images.unsplash.com/photo-1518709268805-4e9042af2176?w=800&q=80",
                    content: "Una startup local ha desarrollado una tecnología que promete cambiar la forma en que interactuamos con dispositivos inteligentes. Los expertos predicen un impacto significativo en la industria. El producto estará disponible a finales de este año.",
                    source: "Zona Total",
                    excerpt: "Innovación tecnológica con potencial disruptivo",
                    active: true
                }
            ];
            
            categories = new Set(['Política', 'Deportes', 'Tecnología']);
            
            // Actualizar la interfaz
            updateCategories();
            filterNews();
            renderNews();
            renderCategories();
            updateNewsCount();
            updateAdminStats();
        }

        function getDefaultImage(category) {
            const categoryImages = {
                'Política': 'https://images.unsplash.com/photo-1551135049-8a33b2fb2f7f?w=800&q=80',
                'Deportes': 'https://images.unsplash.com/photo-1461896836934-ffe607ba8211?w=800&q=80',
                'Economía': 'https://images.unsplash.com/photo-1611974789855-9c2a0a7236a3?w=800&q=80',
                'Tecnología': 'https://images.unsplash.com/photo-1518709268805-4e9042af2176?w=800&q=80',
                'Entretenimiento': 'https://images.unsplash.com/photo-1492684223066-dd23140edf6d?w=800&q=80',
                'Salud': 'https://images.unsplash.com/photo-1559757148-5c350d0d3c56?w=800&q=80',
                'General': 'https://images.unsplash.com/photo-1588681664899-f142ff2dc9b1?w=800&q=80'
            };
            
            return categoryImages[category] || categoryImages['General'];
        }

        function generateExcerpt(text, maxLength) {
            if (!text) return '';
            if (text.length <= maxLength) return text;
            
            return text.substring(0, maxLength) + '...';
        }

        // =============== AGREGAR NOTICIA A GOOGLE SHEETS ===============
        async function addNewsToGoogleSheets(newsData) {
            try {
                // Convertir a formato CSV
                const csvRow = [
                    `"${newsData.title.replace(/"/g, '""')}"`,
                    `"${newsData.description.replace(/"/g, '""')}"`,
                    `"${newsData.category}"`,
                    `"${newsData.country}"`,
                    `"${newsData.date}"`,
                    `"${newsData.priority}"`,
                    `"${newsData.image}"`,
                    `"${newsData.content.replace(/"/g, '""')}"`,
                    `"${newsData.source}"`
                ].join(',');
                
                // Para agregar a Google Sheets necesitamos usar Google Apps Script
                // Como alternativa, guardamos en localStorage y mostramos mensaje
                saveNewsToLocalStorage(newsData);
                
                return {
                    success: true,
                    message: 'Noticia agregada localmente. Para guardar en Google Sheets, copia manualmente los datos.',
                    data: newsData
                };
                
            } catch (error) {
                console.error('Error agregando noticia:', error);
                return {
                    success: false,
                    message: 'Error al agregar noticia'
                };
            }
        }

        function saveNewsToLocalStorage(newsData) {
            try {
                // Obtener noticias existentes
                let localNews = JSON.parse(localStorage.getItem('zona_total_news')) || [];
                
                // Agregar nueva noticia
                newsData.id = Date.now(); // ID único basado en timestamp
                localNews.push(newsData);
                
                // Guardar en localStorage
                localStorage.setItem('zona_total_news', JSON.stringify(localNews));
                
                // Actualizar lista de noticias
                news = [...news, newsData];
                categories.add(newsData.category);
                
                // Actualizar interfaz
                updateCategories();
                filterNews();
                renderNews();
                renderCategories();
                updateNewsCount();
                updateAdminStats();
                
                return true;
            } catch (error) {
                console.error('Error guardando en localStorage:', error);
                return false;
            }
        }

        // =============== RENDERIZAR INTERFAZ ===============
        function updateCategories() {
            const filterButtons = document.getElementById('filter-buttons');
            if (!filterButtons) return;
            
            // Mantener solo el botón "Todas"
            const existingButtons = filterButtons.querySelectorAll('.filter-btn');
            existingButtons.forEach(btn => {
                if (btn.dataset.category !== 'todas') {
                    btn.remove();
                }
            });
            
            // Agregar botones para cada categoría
            Array.from(categories).sort().forEach(category => {
                const button = document.createElement('button');
                button.className = 'filter-btn';
                button.textContent = category;
                button.dataset.category = category.toLowerCase().replace(/ /g, '-');
                
                button.addEventListener('click', () => {
                    currentCategory = category;
                    document.querySelectorAll('.filter-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    button.classList.add('active');
                    currentPage = 1;
                    filterNews();
                    renderNews();
                });
                
                filterButtons.appendChild(button);
            });
        }

        function filterNews() {
            filteredNews = news.filter(item => {
                // Filtrar por categoría
                if (currentCategory !== 'todas' && item.category !== currentCategory) {
                    return false;
                }
                
                // Filtrar por búsqueda
                if (searchQuery) {
                    const searchText = (item.title + ' ' + item.description + ' ' + item.content + ' ' + item.category).toLowerCase();
                    return searchText.includes(searchQuery);
                }
                
                return true;
            });
        }

        function renderNews() {
            const newsGrid = document.getElementById('news-grid');
            if (!newsGrid) return;
            
            // Calcular noticias para esta página
            const startIndex = (currentPage - 1) * newsPerPage;
            const endIndex = startIndex + newsPerPage;
            const newsToShow = filteredNews.slice(startIndex, endIndex);
            
            // Si no hay noticias
            if (filteredNews.length === 0) {
                newsGrid.innerHTML = `
                    <div class="no-news" style="grid-column: 1/-1; text-align: center; padding: 50px 20px;">
                        <i class="fas fa-newspaper" style="font-size: 4rem; color: var(--accent-orange); margin-bottom: 20px; opacity: 0.7;"></i>
                        <h3 style="color: var(--text-color); margin-bottom: 15px;">No se encontraron noticias</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 25px;">
                            ${searchQuery ? 'Prueba con otros términos de búsqueda.' : 'No hay noticias disponibles.'}
                        </p>
                        ${searchQuery ? 
                            '<button onclick="clearSearch()" class="btn btn-primary" style="margin: 10px;">Limpiar búsqueda</button>' : 
                            ''
                        }
                        <button onclick="location.reload()" class="btn btn-secondary" style="margin: 10px;">
                            <i class="fas fa-redo"></i> Recargar
                        </button>
                    </div>
                `;
                
                const loadMoreBtn = document.getElementById('load-more-btn');
                if (loadMoreBtn) loadMoreBtn.style.display = 'none';
                return;
            }
            
            // Renderizar noticias
            newsGrid.innerHTML = '';
            
            newsToShow.forEach(newsItem => {
                const newsCard = createNewsCard(newsItem);
                newsGrid.appendChild(newsCard);
            });
            
            // Mostrar/ocultar botón "Cargar más"
            const loadMoreBtn = document.getElementById('load-more-btn');
            if (loadMoreBtn) {
                if (endIndex < filteredNews.length) {
                    loadMoreBtn.style.display = 'inline-block';
                } else {
                    loadMoreBtn.style.display = 'none';
                }
            }
            
            updateNewsCount();
        }

        function createNewsCard(newsItem) {
            const newsCard = document.createElement('div');
            newsCard.className = 'news-card';
            
            newsCard.innerHTML = `
                <div class="news-image">
                    <img src="${newsItem.image}" alt="${newsItem.title}" 
                         onerror="this.src='${getDefaultImage(newsItem.category)}'">
                    <div class="news-category">${newsItem.category}</div>
                    ${newsItem.priority > 1 ? `<div class="news-priority">Destacado</div>` : ''}
                </div>
                <div class="news-content">
                    <div class="news-header">
                        <h3 class="news-title">${newsItem.title}</h3>
                        <div class="news-date">${newsItem.date}</div>
                    </div>
                    <p class="news-excerpt">${newsItem.excerpt || newsItem.description}</p>
                    <div class="news-meta">
                        <div class="news-author">
                            <i class="fas fa-user"></i>
                            <span>${newsItem.source}</span>
                        </div>
                        ${newsItem.country ? `<div class="news-country"><i class="fas fa-globe"></i> ${newsItem.country}</div>` : ''}
                    </div>
                    <div class="news-actions">
                        <button class="btn btn-primary read-more-btn" data-id="${newsItem.id}">
                            <i class="fas fa-readme"></i> Leer más
                        </button>
                    </div>
                </div>
            `;
            
            // Evento para abrir el modal
            newsCard.querySelector('.read-more-btn').addEventListener('click', () => {
                openNewsModal(newsItem);
            });
            
            return newsCard;
        }

        function renderCategories() {
            const categoriesGrid = document.getElementById('categories-grid');
            if (!categoriesGrid) return;
            
            categoriesGrid.innerHTML = '';
            
            // Contar noticias por categoría
            const categoryCounts = {};
            news.forEach(item => {
                categoryCounts[item.category] = (categoryCounts[item.category] || 0) + 1;
            });
            
            // Renderizar cada categoría
            Object.entries(categoryCounts).forEach(([category, count]) => {
                const categoryCard = document.createElement('div');
                categoryCard.className = 'category-card';
                categoryCard.dataset.category = category;
                
                // Icono según categoría
                let iconClass = 'fas fa-newspaper';
                if (category.includes('Política')) iconClass = 'fas fa-landmark';
                if (category.includes('Deportes')) iconClass = 'fas fa-futbol';
                if (category.includes('Economía')) iconClass = 'fas fa-chart-line';
                if (category.includes('Tecnología')) iconClass = 'fas fa-laptop-code';
                if (category.includes('Entretenimiento')) iconClass = 'fas fa-film';
                if (category.includes('Salud')) iconClass = 'fas fa-heartbeat';
                
                categoryCard.innerHTML = `
                    <div class="category-icon">
                        <i class="${iconClass}"></i>
                    </div>
                    <h3>${category}</h3>
                    <div class="category-count">${count} noticias</div>
                `;
                
                categoryCard.addEventListener('click', () => {
                    currentCategory = category;
                    document.querySelectorAll('.filter-btn').forEach(btn => {
                        btn.classList.remove('active');
                        if (btn.textContent === category) {
                            btn.classList.add('active');
                        }
                    });
                    
                    document.querySelectorAll('.filter-btn').forEach(btn => {
                        if (btn.textContent === 'Todas') {
                            btn.classList.remove('active');
                        }
                    });
                    
                    currentPage = 1;
                    filterNews();
                    renderNews();
                    
                    // Scroll a noticias
                    document.getElementById('news').scrollIntoView({ behavior: 'smooth' });
                });
                
                categoriesGrid.appendChild(categoryCard);
            });
        }

        // =============== FUNCIONALIDADES DEL ADMIN ===============
        function initAdmin() {
            // Botón Admin
            const adminAccessBtn = document.getElementById('admin-access-btn');
            if (adminAccessBtn) {
                adminAccessBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.getElementById('admin-overlay').style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                    updateAdminStats();
                    renderAdminNewsList();
                });
            }
            
            // Login (simplificado para demostración)
            const loginBtn = document.getElementById('login-btn');
            if (loginBtn) {
                loginBtn.addEventListener('click', () => {
                    document.getElementById('admin-login').style.display = 'none';
                    document.getElementById('admin-panel').style.display = 'block';
                });
            }
            
            // Cancelar login
            const cancelLoginBtn = document.getElementById('cancel-login-btn');
            if (cancelLoginBtn) {
                cancelLoginBtn.addEventListener('click', () => {
                    closeAdminPanel();
                });
            }
            
            // Logout
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', () => {
                    document.getElementById('admin-login').style.display = 'block';
                    document.getElementById('admin-panel').style.display = 'none';
                    closeAdminPanel();
                });
            }
            
            // Tabs
            const tabBtns = document.querySelectorAll('.tab-btn');
            tabBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const tabId = this.dataset.tab;
                    
                    tabBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                        if (content.id === tabId) {
                            content.classList.add('active');
                        }
                    });
                });
            });
            
            // Formulario para agregar noticia
            const addNewsForm = document.getElementById('add-news-form');
            if (addNewsForm) {
                addNewsForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const newsData = {
                        title: document.getElementById('news-title').value,
                        description: document.getElementById('news-description').value,
                        category: document.getElementById('news-category').value,
                        country: document.getElementById('news-country').value,
                        date: document.getElementById('news-date').value || new Date().toLocaleDateString('es-ES'),
                        priority: parseInt(document.getElementById('news-priority').value) || 1,
                        image: document.getElementById('news-image').value || getDefaultImage(document.getElementById('news-category').value),
                        content: document.getElementById('news-content').value,
                        source: document.getElementById('news-source').value || 'Zona Total'
                    };
                    
                    // Validar campos requeridos
                    if (!newsData.title || !newsData.description || !newsData.category) {
                        alert('Por favor, completa los campos obligatorios: Título, Descripción y Categoría');
                        return;
                    }
                    
                    // Mostrar mensaje de procesamiento
                    const statusDiv = document.getElementById('form-status');
                    statusDiv.innerHTML = '<div class="processing"><i class="fas fa-spinner fa-spin"></i> Agregando noticia...</div>';
                    
                    // Agregar noticia
                    const result = await addNewsToGoogleSheets(newsData);
                    
                    if (result.success) {
                        statusDiv.innerHTML = `<div class="success">
                            <i class="fas fa-check-circle"></i> ${result.message}
                            <p><strong>Para guardar en Google Sheets:</strong></p>
                            <p>1. Abre tu Google Sheets</p>
                            <p>2. Agrega una nueva fila con estos datos:</p>
                            <pre style="background: #2c2c2c; padding: 10px; border-radius: 4px; margin: 10px 0;">
${newsData.title}
${newsData.description}
${newsData.category}
${newsData.country}
${newsData.date}
${newsData.priority}
${newsData.image}
${newsData.content}
${newsData.source}</pre>
                        </div>`;
                        
                        // Limpiar formulario
                        addNewsForm.reset();
                        
                        // Actualizar lista de noticias en admin
                        setTimeout(() => {
                            renderAdminNewsList();
                            updateAdminStats();
                        }, 500);
                        
                    } else {
                        statusDiv.innerHTML = `<div class="error">
                            <i class="fas fa-exclamation-triangle"></i> ${result.message}
                        </div>`;
                    }
                });
            }
            
            // Actualizar noticias
            const refreshBtn = document.getElementById('refresh-news-btn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', () => {
                    loadNewsFromGoogleSheets();
                    alert('Noticias actualizadas');
                });
            }
            
            // Abrir Google Sheets
            const openSheetsBtn = document.querySelector('[href*="docs.google.com"]');
            if (openSheetsBtn) {
                openSheetsBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    window.open(e.target.href || e.target.parentElement.href, '_blank');
                });
            }
        }

        function renderAdminNewsList() {
            const adminNewsList = document.getElementById('admin-news-list');
            const newsCount = document.getElementById('news-count');
            
            if (!adminNewsList) return;
            
            // Mostrar últimas 10 noticias
            const recentNews = news.slice(0, 10);
            
            adminNewsList.innerHTML = '';
            
            if (recentNews.length === 0) {
                adminNewsList.innerHTML = '<div class="no-news-admin"><p>No hay noticias disponibles.</p></div>';
                if (newsCount) newsCount.textContent = '0 noticias';
                return;
            }
            
            if (newsCount) {
                newsCount.textContent = `${news.length} noticias`;
            }
            
            recentNews.forEach(newsItem => {
                const newsElement = document.createElement('div');
                newsElement.className = 'admin-news-item';
                
                newsElement.innerHTML = `
                    <div class="admin-news-header">
                        <div class="admin-news-title">${newsItem.title}</div>
                        <div class="admin-news-date">${newsItem.date}</div>
                    </div>
                    <div class="admin-news-category">${newsItem.category}</div>
                    <div class="admin-news-excerpt">${newsItem.excerpt || newsItem.description.substring(0, 100)}...</div>
                `;
                
                adminNewsList.appendChild(newsElement);
            });
        }

        function updateAdminStats() {
            const totalNewsElement = document.getElementById('admin-total-news');
            const totalCategoriesElement = document.getElementById('admin-total-categories');
            const lastUpdateElement = document.getElementById('last-update');
            
            if (totalNewsElement) {
                totalNewsElement.textContent = news.length;
            }
            
            if (totalCategoriesElement) {
                totalCategoriesElement.textContent = categories.size;
            }
            
            if (lastUpdateElement) {
                lastUpdateElement.textContent = new Date().toLocaleTimeString('es-ES');
            }
        }

        // =============== FUNCIONES AUXILIARES ===============
        function initNavigation() {
            const hamburger = document.querySelector('.hamburger');
            const navMenu = document.querySelector('.nav-menu');
            
            if (hamburger && navMenu) {
                hamburger.addEventListener('click', () => {
                    hamburger.classList.toggle('active');
                    navMenu.classList.toggle('active');
                });
                
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.addEventListener('click', () => {
                        hamburger.classList.remove('active');
                        navMenu.classList.remove('active');
                    });
                });
            }
        }

        function initSearch() {
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    searchQuery = e.target.value.toLowerCase();
                    currentPage = 1;
                    filterNews();
                    renderNews();
                });
            }
            
            const retryBtn = document.getElementById('retry-load-btn');
            if (retryBtn) {
                retryBtn.addEventListener('click', loadNewsFromGoogleSheets);
            }
        }

        function initModal() {
            const modalClose = document.getElementById('modal-close');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const newsModal = document.getElementById('news-modal');
            
            if (modalClose) modalClose.addEventListener('click', closeNewsModal);
            if (closeModalBtn) closeModalBtn.addEventListener('click', closeNewsModal);
            
            if (newsModal) {
                newsModal.addEventListener('click', (e) => {
                    if (e.target === newsModal) closeNewsModal();
                });
            }
            
            const shareBtn = document.getElementById('share-btn');
            if (shareBtn) {
                shareBtn.addEventListener('click', shareNews);
            }
        }

        function openNewsModal(newsItem) {
            const newsModal = document.getElementById('news-modal');
            const modalNewsTitle = document.getElementById('modal-news-title');
            const modalNewsContent = document.getElementById('modal-news-content');
            
            if (!newsModal || !modalNewsTitle || !modalNewsContent) return;
            
            modalNewsTitle.textContent = newsItem.title;
            
            modalNewsContent.innerHTML = `
                <div class="modal-news-content">
                    <div class="modal-meta">
                        <div class="modal-category">${newsItem.category}</div>
                        <div><i class="fas fa-calendar"></i> ${newsItem.date}</div>
                        <div><i class="fas fa-user"></i> ${newsItem.source}</div>
                        ${newsItem.country ? `<div><i class="fas fa-globe"></i> ${newsItem.country}</div>` : ''}
                    </div>
                    
                    <div class="modal-image">
                        <img src="${newsItem.image}" alt="${newsItem.title}"
                             onerror="this.src='${getDefaultImage(newsItem.category)}'">
                    </div>
                    
                    <div class="modal-body">
                        ${newsItem.content.split('\n').map(paragraph => 
                            `<p>${paragraph}</p>`
                        ).join('')}
                        
                        ${newsItem.description ? `
                            <div class="modal-summary">
                                <h4>Resumen:</h4>
                                <p>${newsItem.description}</p>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            newsModal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            window.currentNewsItem = newsItem;
        }

        function closeNewsModal() {
            const newsModal = document.getElementById('news-modal');
            if (newsModal) {
                newsModal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }

        function closeAdminPanel() {
            document.getElementById('admin-overlay').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        function updateNewsCount() {
            const totalNewsElement = document.getElementById('total-news');
            if (totalNewsElement) {
                totalNewsElement.textContent = news.length;
            }
        }

        function loadMoreNews() {
            currentPage++;
            renderNews();
            
            // Scroll suave a las nuevas noticias
            const newsGrid = document.getElementById('news-grid');
            if (newsGrid && newsGrid.lastElementChild) {
                newsGrid.lastElementChild.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        function shareNews() {
            if (!window.currentNewsItem) return;
            
            const newsItem = window.currentNewsItem;
            const shareText = `Lee "${newsItem.title}" en Zona Total Noticias`;
            const shareUrl = window.location.href;
            
            if (navigator.share) {
                navigator.share({
                    title: newsItem.title,
                    text: shareText,
                    url: shareUrl
                });
            } else {
                // Fallback
                navigator.clipboard.writeText(`${shareText}: ${shareUrl}`);
                alert('Enlace copiado al portapapeles');
            }
        }

        function showLoading(show) {
            const loadingElement = document.getElementById('loading-news');
            const errorElement = document.getElementById('error-news');
            
            if (loadingElement) {
                loadingElement.style.display = show ? 'block' : 'none';
            }
            
            if (errorElement) {
                errorElement.style.display = 'none';
            }
        }

        function showError(message) {
            const loadingElement = document.getElementById('loading-news');
            const errorElement = document.getElementById('error-news');
            const errorMessage = document.getElementById('error-message');
            
            if (loadingElement) {
                loadingElement.style.display = 'none';
            }
            
            if (errorElement && errorMessage) {
                errorMessage.textContent = message;
                errorElement.style.display = 'block';
            }
        }

        // =============== FUNCIONES GLOBALES ===============
        window.clearSearch = function() {
            searchQuery = '';
            const searchInput = document.getElementById('search-input');
            if (searchInput) searchInput.value = '';
            currentCategory = 'todas';
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.category === 'todas') {
                    btn.classList.add('active');
                }
            });
            
            currentPage = 1;
            filterNews();
            renderNews();
        };

        window.openNewsModal = openNewsModal;
        window.closeNewsModal = closeNewsModal;
        window.loadNewsFromGoogleSheets = loadNewsFromGoogleSheets;
    </script>
</body>
</html>
